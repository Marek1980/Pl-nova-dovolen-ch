<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Pl치nova캜 Dovolen칳ch + Kalend치콏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f3f4f6; color: #1f2937; }
    h2, h3 { color: #111827; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
    
    input { padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; box-sizing: border-box; }
    button { padding: 10px 15px; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; transition: background 0.2s; }
    button:hover { background: #1d4ed8; }
    button.secondary { background: #6b7280; width: auto; }
    
    /* KALEND츼콎 STYLY */
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .day-name { font-weight: bold; text-align: center; color: #6b7280; font-size: 0.9em; padding-bottom: 5px; }
    .day { height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; padding: 5px; font-size: 0.9em; position: relative; background: white; overflow: hidden; }
    
    .day-number { font-weight: bold; margin-bottom: 2px; }
    .day.weekend { background-color: #f9fafb; color: #9ca3af; }
    .day.holiday { background-color: #fff1f2; color: #991b1b; border-color: #fecaca; }
    .holiday-name { font-size: 0.7em; display: block; line-height: 1.1; }
    
    .event-bar { display: block; font-size: 0.7em; padding: 2px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .approved { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .pending { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    
    .other-month { opacity: 0.3; }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    // --- 拘勇 ZDE VLO콯 SV칄 KL칈캛E ZE SUPABASE 拘勇 ---
    const SUPABASE_URL = 'https://bprawiumolizfnhuigpf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_OCC-K3xibSWzFoLgcQ7kyg_39EH34zQ';
    // ---------------------------------------------

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 캛ESK칄 SV츼TKY (2026) ---
    const holidays = {
      '1-1': 'Nov칳 rok',
      '3-4': 'Velk칳 p치tek', // 2026
      '6-4': 'Velikonoce',  // 2026
      '1-5': 'Sv치tek pr치ce',
      '8-5': 'Den v칤t캩zstv칤',
      '5-7': 'C. a Metod캩j',
      '6-7': 'Jan Hus',
      '28-9': 'V치clav',
      '28-10': 'Vznik 캛SR',
      '17-11': 'Den boje',
      '24-12': '맚캩dr칳 den',
      '25-12': '1. sv치tek',
      '26-12': '2. sv치tek'
    };

    function Calendar({ requests }) {
      const [currentDate, setCurrentDate] = React.useState(new Date());

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, month, 1).getDay(); 
      // 칔prava: JS vrac칤 ned캩li jako 0, my chceme pond캩l칤 jako 0.
      const startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

      const changeMonth = (offset) => {
        setCurrentDate(new Date(year, month + offset, 1));
      };

      const renderDays = () => {
        const days = [];
        const dayNames = ['Po', '칔t', 'St', '캛t', 'P치', 'So', 'Ne'];
        
        // Hlavi캜ka dn콢
        dayNames.forEach(d => days.push(<div key={d} className="day-name">{d}</div>));

        // Pr치zdn치 pol칤캜ka p콏ed za캜치tkem m캩s칤ce
        for (let i = 0; i < startDay; i++) {
          days.push(<div key={`empty-${i}`} className="day other-month"></div>);
        }

        // Dny v m캩s칤ci
        for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dayOfWeek = dateObj.getDay();
          const dateKey = `${d}-${month + 1}`;
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
          const holidayName = holidays[dateKey];

          // Naj칤t dovolen칠 pro tento den
          const todaysLeaves = requests.filter(req => {
            const start = new Date(req.date_from);
            const end = new Date(req.date_to);
            // Reset 캜asu pro porovn치n칤
            start.setHours(0,0,0,0);
            end.setHours(0,0,0,0);
            return dateObj >= start && dateObj <= end;
          });

          days.push(
            <div key={d} className={`day ${isWeekend ? 'weekend' : ''} ${holidayName ? 'holiday' : ''}`}>
              <div className="day-number">{d}</div>
              {holidayName && <span className="holiday-name">{holidayName}</span>}
              
              {todaysLeaves.map(req => (
                <span key={req.id} className={`event-bar ${req.status}`}>
                  {req.profiles?.full_name || 'J치'}
                </span>
              ))}
            </div>
          );
        }
        return days;
      };

      return (
        <div className="card">
          <div className="calendar-header">
            <button className="secondary" onClick={() => changeMonth(-1)}>&lt; P콏edchoz칤</button>
            <h3 style={{margin:0}}>{currentDate.toLocaleString('cs-CZ', { month: 'long', year: 'numeric' })}</h3>
            <button className="secondary" onClick={() => changeMonth(1)}>Dal코칤 &gt;</button>
          </div>
          <div className="calendar-grid">
            {renderDays()}
          </div>
        </div>
      );
    }

    function App() {
      const [session, setSession] = React.useState(null);
      const [loading, setLoading] = React.useState(false);
      const [requests, setRequests] = React.useState([]);
      
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [dateFrom, setDateFrom] = React.useState('');
      const [dateTo, setDateTo] = React.useState('');

      React.useEffect(() => {
        supabase.auth.getSession().then(({ data: { session } }) => {
          setSession(session);
          if(session) fetchRequests();
        });

        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          setSession(session);
          if(session) fetchRequests();
        });

        return () => subscription.unsubscribe();
      }, []);

      const fetchRequests = async () => {
        const { data, error } = await supabase
          .from('leave_requests')
          .select('*, profiles(full_name)')
          .order('created_at', { ascending: false });
        if (!error) setRequests(data);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
           const { error: signUpError } = await supabase.auth.signUp({ email, password });
           if (signUpError) alert(signUpError.message);
           else alert("Registrace 칰sp캩코n치! Jsi p콏ihl치코en.");
        }
        setLoading(false);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!dateFrom || !dateTo) return;
        
        const { data: { user } } = await supabase.auth.getUser();

        // Profil
        const { data: profile } = await supabase.from('profiles').select('id').eq('id', user.id).single();
        if (!profile) {
            await supabase.from('profiles').insert([{ id: user.id, full_name: email.split('@')[0] }]);
        }

        // Vlo쬰n칤
        const { error } = await supabase.from('leave_requests').insert([
          { user_id: user.id, date_from: dateFrom, date_to: dateTo }
        ]);

        if (error) alert('Chyba: ' + error.message);
        else {
            alert('콯치dost odesl치na!');
            fetchRequests();
        }
      };

      // --- LOGIN OBRAZOVKA ---
      if (!session) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="card" style={{width: '350px', textAlign: 'center'}}>
              <h2>游댏 P콏ihl치코en칤</h2>
              <form onSubmit={handleLogin}>
                <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} required style={{marginBottom: '10px'}}/>
                <input type="password" placeholder="Heslo" value={password} onChange={e => setPassword(e.target.value)} required style={{marginBottom: '20px'}}/>
                <button type="submit" disabled={loading}>{loading ? '캛ekej...' : 'Vstoupit'}</button>
              </form>
            </div>
          </div>
        );
      }

      // --- HLAVN칈 APLIKACE ---
      return (
        <div>
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: '20px'}}>
            <h3>游꺖 Pl치nova캜 dovolen칳ch</h3>
            <button className="secondary" onClick={() => supabase.auth.signOut()}>Odhl치sit</button>
          </div>

          <div className="card">
            <h4>Nov치 쮂멳ost</h4>
            <form onSubmit={handleSubmit} style={{display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                <div style={{flex: 1, minWidth: '150px'}}>
                    <label style={{fontSize: '0.8em', color: '#666'}}>Od:</label>
                    <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} /> 
                </div>
                <div style={{flex: 1, minWidth: '150px'}}>
                    <label style={{fontSize: '0.8em', color: '#666'}}>Do:</label>
                    <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} /> 
                </div>
                <div style={{alignSelf: 'flex-end', minWidth: '100px'}}>
                     <button type="submit" style={{marginBottom: '5px'}}>Odeslat</button>
                </div>
            </form>
          </div>

          {/* VLO콯EN칈 KALEND츼콎E */}
          <Calendar requests={requests} />

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

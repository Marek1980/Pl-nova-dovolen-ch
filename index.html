<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pl√°novaƒç dovolen√Ωch</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; }
        button:hover { background: #2563eb; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .btn-approve { background: #22c55e; width: auto; margin-right: 5px; }
        .btn-reject { background: #ef4444; width: auto; }
        .debug-bar { background: #fffbeb; border: 2px solid #fbbf24; color: #92400e; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-family: monospace; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ‚ùó‚ùó ZDE DOPL≈á SV√â √öDAJE ‚ùó‚ùó
        const SUPABASE_URL = 'https://bprawiumolizfnhuigpf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_OCC-K3xibSWzFoLgcQ7kyg_39EH34zQ';
        
        // ‚ùó‚ùó TADY MUS√ç B√ùT TV≈ÆJ EMAIL P≈òESNƒö NA ZNAK ‚ùó‚ùó
        const ADMIN_EMAIL = 'marek.horacek@alza.cz'; 

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function App() {
            const [session, setSession] = React.useState(null);
            const [requests, setRequests] = React.useState([]);
            const [form, setForm] = React.useState({ email: '', pass: '', from: '', to: '' });
            const [isAdmin, setIsAdmin] = React.useState(false);

            React.useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) checkUser(session);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) checkUser(session);
                });
                return () => subscription.unsubscribe();
            }, []);

            const checkUser = (s) => {
                // Tady prob√≠h√° kontrola:
                const jeToAdmin = s.user.email.trim().toLowerCase() === ADMIN_EMAIL.trim().toLowerCase();
                setIsAdmin(jeToAdmin);
                fetchRequests();
            };

            const fetchRequests = async () => {
                const { data } = await supabase.from('leave_requests').select('*, profiles(full_name)').order('created_at', { ascending: false });
                setRequests(data || []);
            };

            const handleStatus = async (id, status) => {
                if (confirm('Opravdu chcete zmƒõnit stav?')) {
                    await supabase.from('leave_requests').update({ status }).eq('id', id);
                    fetchRequests();
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const { error } = await supabase.auth.signInWithPassword({ email: form.email, password: form.pass });
                if (error) {
                    const { error: signUpError } = await supabase.auth.signUp({ email: form.email, password: form.pass });
                    if (signUpError) alert("Chyba: " + signUpError.message);
                    else alert("√öƒçet vytvo≈ôen! Zkontroluj email nebo se zkus p≈ôihl√°sit znovu.");
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const { data: { user } } = await supabase.auth.getUser();
                // Ulo≈æen√≠ jm√©na (pokud neexistuje)
                await supabase.from('profiles').upsert({ id: user.id, full_name: user.email.split('@')[0] });
                // Ulo≈æen√≠ ≈æ√°dosti
                const { error } = await supabase.from('leave_requests').insert([{ user_id: user.id, date_from: form.from, date_to: form.to }]);
                
                if(error) alert('Chyba: ' + error.message);
                else { alert('Odesl√°no ke schv√°len√≠!'); fetchRequests(); }
            };

            if (!session) return (
                <div style={{display:'flex', justifyContent:'center', height:'100vh', alignItems:'center'}}>
                    <form className="card" onSubmit={handleLogin} style={{width:300, textAlign:'center'}}>
                        <h2>üîê P≈ôihl√°≈°en√≠</h2>
                        <input type="email" placeholder="Email" onChange={e => setForm({...form, email:e.target.value})} required style={{marginBottom:10}} />
                        <input type="password" placeholder="Heslo" onChange={e => setForm({...form, pass:e.target.value})} required style={{marginBottom:15}} />
                        <button>Vstoupit</button>
                    </form>
                </div>
            );

            const pending = requests.filter(r => r.status === 'pending');

            return (
                <div>
                    {/* üïµÔ∏è DETEKTIVN√ç LI≈†TA - uk√°≈æe ti pravdu */}
                    <div className="debug-bar">
                        <strong>üïµÔ∏è DETEKTIVN√ç INFO:</strong><br/>
                        P≈ôihl√°≈°en√Ω email (Supabase): <b>"{session.user.email}"</b><br/>
                        Email v k√≥du (ADMIN_EMAIL): <b>"{ADMIN_EMAIL}"</b><br/>
                        <hr style={{borderColor:'#fbbf24'}}/>
                        Shoduj√≠ se? üëâ <b>{isAdmin ? "‚úÖ ANO (Jsi Admin)" : "‚ùå NE (Jsi Zamƒõstnanec)"}</b>
                    </div>

                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:20}}>
                        <h3>üå¥ Pl√°novaƒç {isAdmin && <span style={{color:'red'}}>(ADMIN)</span>}</h3>
                        <button onClick={() => supabase.auth.signOut()} style={{width:'auto', background:'#666'}}>Odhl√°sit</button>
                    </div>

                    {isAdmin ? (
                        // POHLED PRO ADMINA
                        <div className="card" style={{borderLeft:'5px solid #22c55e'}}>
                            <h2 style={{marginTop:0}}>üëë Spr√°va dovolen√Ωch</h2>
                            {pending.length === 0 ? <p>≈Ω√°dn√© nov√© ≈æ√°dosti ke schv√°len√≠. üëç</p> : 
                                pending.map(r => (
                                    <div key={r.id} style={{display:'flex', justifyContent:'space-between', alignItems:'center', borderBottom:'1px solid #eee', padding:'10px 0'}}>
                                        <div>
                                            <strong>{r.profiles?.full_name || r.user_id}</strong><br/>
                                            {r.date_from} ‚Äî {r.date_to}
                                        </div>
                                        <div>
                                            <button className="btn-approve" onClick={()=>handleStatus(r.id, 'approved')}>Schv√°lit</button>
                                            <button className="btn-reject" onClick={()=>handleStatus(r.id, 'rejected')}>Zam√≠tnout</button>
                                        </div>
                                    </div>
                                ))
                            }
                            <h4 style={{marginTop:20, color:'#888'}}>Historie v≈°ech ≈æ√°dost√≠:</h4>
                            <ul style={{color:'#666'}}>
                                {requests.filter(r => r.status !== 'pending').map(r => (
                                    <li key={r.id}>{r.date_from} - {r.status === 'approved' ? '‚úÖ' : '‚ùå'} ({r.profiles?.full_name})</li>
                                ))}
                            </ul>
                        </div>
                    ) : (
                        // POHLED PRO ZAMƒöSTNANCE
                        <div className="card">
                            <h3>‚ûï Nov√° ≈æ√°dost</h3>
                            <form onSubmit={handleSubmit} style={{display:'flex', gap:10, flexDirection:'column'}}>
                                <label>Od: <input type="date" onChange={e => setForm({...form, from:e.target.value})} required /></label>
                                <label>Do: <input type="date" onChange={e => setForm({...form, to:e.target.value})} required /></label>
                                <button>Odeslat ≈æ√°dost</button>
                            </form>
                            
                            <h4>Moje ≈æ√°dosti:</h4>
                            {requests.filter(r => r.user_id === session.user.id).map(r => (
                                <div key={r.id} style={{padding:5, borderBottom:'1px solid #eee'}}>
                                    {r.date_from} a≈æ {r.date_to}: 
                                    {r.status === 'pending' ? ' üü† ƒåek√° se' : r.status === 'approved' ? ' ‚úÖ Schv√°leno' : ' ‚ùå Zam√≠tnuto'}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

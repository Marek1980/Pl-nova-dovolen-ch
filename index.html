<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pl√°novaƒç dovolen√Ωch</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: #1e293b; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { background: #2563eb; }
        .btn-secondary { background: #94a3b8; width: auto; padding: 8px 16px; font-size: 0.9em; }
        .btn-approve { background: #22c55e; width: auto; margin-right: 8px; }
        .btn-reject { background: #ef4444; width: auto; }
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-approved { color: #22c55e; font-weight: bold; }
        .status-rejected { color: #ef4444; font-weight: bold; text-decoration: line-through; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .day { padding: 10px; background: #f8fafc; border-radius: 4px; text-align: center; font-size: 0.9em; border: 1px solid #e2e8f0; }
        .day.busy { background: #dbeafe; border-color: #3b82f6; color: #1e40af; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --------------------------------------------------------
        // ‚ùó‚ùó ZDE DOPL≈á SVOJE √öDAJE (U≈æ naposledy!) ‚ùó‚ùó
        // --------------------------------------------------------
        const SUPABASE_URL = 'https://bprawiumolizfnhuigpf.supabase.co';
        const SUPABASE_KEY = 'tsb_publishable_OCC-K3xibSWzFoLgcQ7kyg_39EH34zQ';
        const ADMIN_EMAIL = 'marek.horacek@alza.cz'; 
        // --------------------------------------------------------

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Komponenta Kalend√°≈ô
        function Calendar({ requests }) {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const isBusy = (day) => {
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                // Hled√°me schv√°lenou dovolenou pro tento den
                return requests.find(r => 
                    r.status === 'approved' && 
                    r.date_from <= dateStr && 
                    r.date_to >= dateStr
                );
            };

            return (
                <div className="card">
                    <h3>üìÖ Kalend√°≈ô (Tento mƒõs√≠c)</h3>
                    <div className="calendar-grid">
                        {days.map(d => {
                            const busy = isBusy(d);
                            return (
                                <div key={d} className={`day ${busy ? 'busy' : ''}`} title={busy ? busy.profiles?.full_name : ''}>
                                    {d}
                                    {busy && <div style={{fontSize:'0.6em', marginTop:2}}>{busy.profiles?.full_name.split(' ')[0]}</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function App() {
            const [session, setSession] = React.useState(null);
            const [requests, setRequests] = React.useState([]);
            const [form, setForm] = React.useState({ email: '', pass: '', from: '', to: '' });
            const [isAdmin, setIsAdmin] = React.useState(false);

            React.useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) checkUser(session);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) checkUser(session);
                });
                return () => subscription.unsubscribe();
            }, []);

            const checkUser = (s) => {
                const userEmail = s.user.email.toLowerCase().trim();
                const adminEmail = ADMIN_EMAIL.toLowerCase().trim();
                setIsAdmin(userEmail === adminEmail);
                fetchRequests();
            };

            const fetchRequests = async () => {
                const { data } = await supabase.from('leave_requests').select('*, profiles(full_name)').order('date_from', { ascending: true });
                setRequests(data || []);
            };

            const handleStatus = async (id, status) => {
                if (!confirm(`Opravdu chcete tuto ≈æ√°dost ${status === 'approved' ? 'SCHV√ÅLIT' : 'ZAM√çTNOUT'}?`)) return;
                
                const { error } = await supabase.from('leave_requests').update({ status }).eq('id', id);
                if (error) alert("Chyba: " + error.message);
                else fetchRequests();
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const { error } = await supabase.auth.signInWithPassword({ email: form.email, password: form.pass });
                if (error) {
                    const { error: signUpError } = await supabase.auth.signUp({ email: form.email, password: form.pass });
                    if (signUpError) alert("Chyba p≈ôihl√°≈°en√≠: " + signUpError.message);
                    else alert("Nov√Ω √∫ƒçet vytvo≈ôen! Zkontroluj email nebo se p≈ôihlas znovu.");
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const { data: { user } } = await supabase.auth.getUser();
                await supabase.from('profiles').upsert({ id: user.id, full_name: user.email.split('@')[0] });
                
                const { error } = await supabase.from('leave_requests').insert([{ user_id: user.id, date_from: form.from, date_to: form.to }]);
                
                if (error) alert("Chyba: " + error.message);
                else {
                    alert("≈Ω√°dost odesl√°na ke schv√°len√≠! üå¥");
                    fetchRequests();
                }
            };

            if (!session) return (
                <div style={{display:'flex', justifyContent:'center', alignItems:'center', height:'100vh'}}>
                    <form className="card" onSubmit={handleLogin} style={{width: 300, textAlign:'center'}}>
                        <h2>üîê P≈ôihl√°≈°en√≠</h2>
                        <input type="email" placeholder="Email" onChange={e => setForm({...form, email:e.target.value})} required />
                        <input type="password" placeholder="Heslo" onChange={e => setForm({...form, pass:e.target.value})} required />
                        <button style={{marginTop:10}}>Vstoupit</button>
                    </form>
                </div>
            );

            const pendingRequests = requests.filter(r => r.status === 'pending');

            return (
                <div className="container">
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:20}}>
                        <h2>üå¥ Pl√°novaƒç dovolen√Ωch</h2>
                        <div style={{textAlign:'right'}}>
                            <span style={{marginRight:10, fontSize:'0.9em', color:'#666'}}>{session.user.email} {isAdmin && 'üëë'}</span>
                            <button onClick={() => supabase.auth.signOut()} className="btn-secondary">Odhl√°sit</button>
                        </div>
                    </div>

                    {/* --- ADMIN SEKCE --- */}
                    {isAdmin && (
                        <div className="card" style={{borderLeft: '4px solid #3b82f6'}}>
                            <h3>üëë Spr√°va ≈æ√°dost√≠ ({pendingRequests.length})</h3>
                            {pendingRequests.length === 0 ? <p style={{color:'#666'}}>V≈°e je vy≈ô√≠zeno. üëç</p> : 
                                pendingRequests.map(r => (
                                    <div key={r.id} className="row">
                                        <div>
                                            <strong>{r.profiles?.full_name || 'Nezn√°m√Ω'}</strong><br/>
                                            <span style={{fontSize:'0.9em', color:'#555'}}>üìÖ {r.date_from} ‚Äî {r.date_to}</span>
                                        </div>
                                        <div>
                                            <button className="btn-approve" onClick={() => handleStatus(r.id, 'approved')}>‚úÖ</button>
                                            <button className="btn-reject" onClick={() => handleStatus(r.id, 'rejected')}>‚ùå</button>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    )}

                    {/* --- ZAMƒöSTNANECK√Å SEKCE (Formul√°≈ô) --- */}
                    {/* Admin vid√≠ formul√°≈ô tak√©, ale m≈Ø≈æe ho ignorovat */}
                    <div className="card">
                        <h3>‚ûï Nov√° ≈æ√°dost</h3>
                        <form onSubmit={handleSubmit} style={{display:'flex', gap:10, flexWrap:'wrap'}}>
                            <div style={{flex:1}}>
                                <label style={{fontSize:'0.8em'}}>Od:</label>
                                <input type="date" onChange={e => setForm({...form, from:e.target.value})} required />
                            </div>
                            <div style={{flex:1}}>
                                <label style={{fontSize:'0.8em'}}>Do:</label>
                                <input type="date" onChange={e => setForm({...form, to:e.target.value})} required />
                            </div>
                            <button style={{width:'auto', marginTop:26}}>Odeslat ≈æ√°dost</button>
                        </form>
                    </div>

                    {/* --- MOJE ≈Ω√ÅDOSTI (Historie) --- */}
                    <div className="card">
                        <h3>üìã Historie ≈æ√°dost√≠</h3>
                        {requests.length === 0 && <p>Zat√≠m ≈æ√°dn√© z√°znamy.</p>}
                        {requests.map(r => (
                            <div key={r.id} className="row">
                                <div>
                                    <strong>{r.profiles?.full_name}</strong> ({r.date_from} ‚Äî {r.date_to})
                                </div>
                                <div className={`status-${r.status}`}>
                                    {r.status === 'pending' ? 'ƒåek√° se üü†' : r.status === 'approved' ? 'Schv√°leno ‚úÖ' : 'Zam√≠tnuto ‚ùå'}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* --- KALEND√Å≈ò (Vid√≠ v≈°ichni) --- */}
                    <Calendar requests={requests} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
